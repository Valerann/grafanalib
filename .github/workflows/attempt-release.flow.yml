# Generated by Flow - do not edit the file
# Version: 1.0.164
name: attempt-release
on:
  push:
    branches:
      - 'feature/**'
      - 'bug/**'
      - 'hotfix/**'
jobs:
  check-release:
    runs-on: [self-hosted, linux, X64, dev, vm]
    steps:
      - uses: actions/checkout@master
      - name: Check releasability, manifests and analyze code
        env:
          GH_TOKEN: ${{ secrets.VLN_GH_TOKEN }}
          SNYK_TOKEN: ${{ secrets.VLN_SNYK_TOKEN }}
          JIRA_API_TOKEN: ${{ secrets.VLN_JIRA_API_TOKEN }}
        run: |
          git fetch --tags 2>/dev/null

          flow end --check --fail-on-warnings
          vsnyk test


  attempt-build:
    strategy:
      matrix:
       component: [grafanalib]
    env:
      COMPONENT: ${{ matrix.component }}
      GH_TOKEN: ${{ secrets.VLN_GH_TOKEN }}
      SLACK_TOKEN: ${{ secrets.VLN_SLACK_TOKEN }}
      JIRA_API_TOKEN: ${{ secrets.VLN_JIRA_API_TOKEN }}
    runs-on: [self-hosted, linux, X64, dev, vm]
    steps:
      - uses: actions/checkout@master
        with:
          ssh-key: ${{ secrets.VLN_SSH_KEY }}
      - name: attempt-build
        run: |
          echo "-- Runner: $GITHUB_RUNNER_NAME --"
          echo $PATH
          git fetch --tags 2>/dev/null

          export TAG=$(echo $GITHUB_SHA | cut -b 1-7)
          export STAGE=dev
          export EXACT=true

          flow release $COMPONENT --patch --dry-run --skip-git-status --skip-slack --skip-prod --skip-docker --skip-snyk

          vpoetry publish $COMPONENT

  attempt-containers:
    env:
      GH_TOKEN: ${{ secrets.VLN_GH_TOKEN }}
      SLACK_TOKEN: ${{ secrets.VLN_SLACK_TOKEN }}
      JIRA_API_TOKEN: ${{ secrets.VLN_JIRA_API_TOKEN }}
      SNYK_TOKEN: ${{ secrets.VLN_SNYK_TOKEN }}
    runs-on: [self-hosted, linux, X64, dev, vm]
    steps:
      - uses: actions/checkout@master
        with:
          fetch-depth: 2
          ssh-key: ${{ secrets.VLN_SSH_KEY }}
      - name: attempt-containers
        run: |
          echo "-- Runner: $GITHUB_RUNNER_NAME --"
          echo $PATH
          git fetch --tags 2>/dev/null

          export TAG=$(echo $GITHUB_SHA | cut -b 1-7)
          export STAGE=dev
          export EXACT=true


          ###
          # will perform pre-commit, flow test, and vln docker build
          ###

          flow release $COMPONENT --patch --dry-run --skip-git-status --skip-slack --skip-prod --skip-test --skip-snyk

          vdocker push $COMPONENT

      - name: snyk-test-containers
        run: |
          vsnyk end
          vsnyk container test $COMPONENT --if-git-changed

  collect-metrics:
    if: ${{ always() }}
    env:
      GH_TOKEN: ${{ secrets.VLN_GH_TOKEN }}
    # this job must run after all previous jobs has concluded. So make sure to set the 'needs' correctly for non-flow workflows.
    needs: [check-release, attempt-build, attempt-containers]
    runs-on: [self-hosted, linux, X64, dev, vm]
    steps:
      - name: collect-metrics
        run: |
          tim collect-metrics github-workflow