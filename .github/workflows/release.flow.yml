# Generated by Flow - do not edit the file
# Version: 1.0.164
name: release
on:
  push:
    branches:
      - 'dev'
    tags-ignore:
      - 'v*'
    paths-ignore:
      - VERSION
      - ISSUELOG.*
      - CHANGELOG.md
      - pyproject.toml
      - '**/pyproject.toml'
      - package.json
      - '**/package.json'
jobs:
  release:
    env:
      GH_TOKEN: ${{ secrets.VLN_GH_TOKEN }}
      SLACK_TOKEN: ${{ secrets.VLN_SLACK_TOKEN }}
      JIRA_API_TOKEN: ${{ secrets.VLN_JIRA_API_TOKEN }}
      SNYK_TOKEN: ${{ secrets.VLN_SNYK_TOKEN }}
    runs-on: [self-hosted, linux, X64, dev, vm]
    steps:
      - uses: actions/checkout@master
        with:
          ssh-key: ${{ secrets.VLN_SSH_KEY }}
          fetch-depth: 0
      - name: release
        run: |
          echo "-- Runner: $GITHUB_RUNNER_NAME --"
          git fetch --tags 2>/dev/null
          flow end --check
          flow release --patch --non-interactive --slack-channel flows
      - name: snyk-monitor
        run: |
          vsnyk monitor
      - name: clean-up
        run: |
          echo "-- Runner: $GITHUB_RUNNER_NAME --"
          merged_issue=$(tail -n 1 ISSUELOG.csv | cut -d "," -f4)
          # vdocker rm --tag $merged_issue --stage dev
          vpoetry rm --preview $merged_issue --stage dev

          # deleting the virtual env on TIM
          rm -rf ~/.cache/pypoetry/virtualenvs/$merged_issue
          rm -rf ~/.cache/pypoetry/virtualenvs/$(flow version)/$GITHUB_REPOSITORY

  collect-metrics:
    if: ${{ always() }}
    env:
      GH_TOKEN: ${{ secrets.VLN_GH_TOKEN }}
    needs: [release]
    runs-on: [self-hosted, linux, X64, dev, vm]
    steps:
      - name: collect-metrics
        run: |
          tim collect-metrics github-workflow